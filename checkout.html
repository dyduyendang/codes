<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán | IVY moda</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .checkout-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .checkout-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .checkout-header h1 {
            font-size: 28px;
            color: #221f20;
            margin-bottom: 10px;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 30px;
        }

        .checkout-form {
            background: #fff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #221f20;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .payment-methods {
            display: grid;
            gap: 15px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .payment-method:hover {
            border-color: #221f20;
        }

        .payment-method.active {
            border-color: #221f20;
            background: #f8f8f8;
        }

        .payment-method input[type="radio"] {
            margin-right: 10px;
        }

        .payment-method img {
            height: 24px;
            margin-left: 10px;
        }

        .order-summary {
            background: #fff;
            border-radius: 8px;
            padding: 30px;
            height: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .order-items {
            margin-bottom: 30px;
        }

        .order-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item img {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        .item-info h4 {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .item-info p {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .item-price {
            color: #221f20;
            font-weight: bold;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #666;
        }

        .summary-total {
            border-top: 2px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
            font-weight: bold;
            color: #221f20;
            font-size: 18px;
        }

        .place-order-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: #221f20;
            color: white;
            border: none;
            border-radius: 4px;
            margin-top: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
        }

        .place-order-btn:hover {
            background: #000;
        }

        @media (max-width: 768px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="/"><img src="images/logo.png" alt="IVY moda"></a>
        </div>
    </header>

    <main>
        <div class="checkout-container">
            <div class="checkout-header">
                <h1>Thanh toán</h1>
            </div>

            <div class="checkout-grid">
                <div class="checkout-form">
                    <form id="checkout-form">
                        <div class="form-section">
                            <h3>Thông tin giao hàng</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">Họ</label>
                                    <input type="text" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Tên</label>
                                    <input type="text" id="lastName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Số điện thoại</label>
                                <input type="tel" id="phone" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Địa chỉ</label>
                                <input type="text" id="address" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">Tỉnh/Thành phố</label>
                                    <select id="city" required>
                                        <option value="">Chọn tỉnh/thành phố</option>
                                        <option value="hanoi">Hà Nội</option>
                                        <option value="hcm">TP. Hồ Chí Minh</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="district">Quận/Huyện</label>
                                    <select id="district" required>
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="note">Ghi chú</label>
                                <textarea id="note" placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Phương thức thanh toán</h3>
                            <div class="payment-methods">
                                <label class="payment-method active">
                                    <input type="radio" name="payment" value="cod" checked>
                                    <span>Thanh toán khi nhận hàng (COD)</span>
                                </label>
                                <label class="payment-method">
                                    <input type="radio" name="payment" value="bank">
                                    <span>Chuyển khoản ngân hàng</span>
                                    <img src="images/payment/bank-transfer.png" alt="Bank transfer">
                                </label>
                                <label class="payment-method">
                                    <input type="radio" name="payment" value="momo">
                                    <span>Ví MoMo</span>
                                    <img src="images/payment/momo.png" alt="MoMo">
                                </label>
                                <label class="payment-method">
                                    <input type="radio" name="payment" value="vnpay">
                                    <span>VNPay</span>
                                    <img src="images/payment/vnpay.png" alt="VNPay">
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="order-summary">
                    <h3>Đơn hàng của bạn</h3>
                    <div id="orderItems" class="order-items">
                        <!-- Items will be rendered here -->
                    </div>

                    <div class="summary-row">
                        <span>Tạm tính:</span>
                        <span id="subtotal">0₫</span>
                    </div>
                    <div class="summary-row">
                        <span>Phí vận chuyển:</span>
                        <span>Miễn phí</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Tổng cộng:</span>
                        <span id="total">0₫</span>
                    </div>

                    <button class="place-order-btn" onclick="placeOrder()">
                        Đặt hàng
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h3>Về IVY moda</h3>
                <ul>
                    <li><a href="thong-tin/ve-chung-toi.html">Giới thiệu</a></li>
                    <li><a href="thong-tin/lien-he.html">Liên hệ</a></li>
                    <li><a href="#">Tuyển dụng</a></li>
                    <li><a href="#">Tin tức</a></li>
                    <li><a href="#">Hệ thống cửa hàng</a></li>
                </ul>
            </div>
            
            <div class="footer-column">
                <h3>Hỗ trợ khách hàng</h3>
                <ul>
                    <li><a href="#">Hướng dẫn chọn size</a></li>
                    <li><a href="#">Chính sách khách hàng VIP</a></li>
                    <li><a href="#">Chính sách đổi trả</a></li>
                    <li><a href="#">Chính sách bảo mật</a></li>
                    <li><a href="#">Thanh toán, giao nhận</a></li>
                </ul>
            </div>
            
            <div class="footer-column">
                <h3>Liên hệ</h3>
                <div class="contact-info">
                    <p><i class="fas fa-phone"></i> Hotline: 0123 456 789</p>
                    <p><i class="fas fa-envelope"></i> Email: cs@ivymoda.vn</p>
                    <p><i class="fas fa-map-marker-alt"></i> Tầng 12, Tòa nhà IVY, Số 123 Nguyễn Trãi, Thanh Xuân, Hà Nội</p>
                </div>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-tiktok"></i></a>
                </div>
            </div>
            
            <div class="footer-column">
                <h3>Đăng ký nhận tin</h3>
                <p style="color: #999; margin-bottom: 15px">Nhận thông tin sản phẩm mới nhất, tin khuyến mãi và nhiều hơn nữa.</p>
                <form class="newsletter-form">
                    <input type="email" placeholder="Email của bạn" required>
                    <button type="submit">Đăng ký</button>
                </form>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>© 2025 IVY moda All rights reserved</p>
            <div class="payment-methods">
                <img src="images/payment/visa.png" alt="Visa">
                <img src="images/payment/mastercard.png" alt="Mastercard">
                <img src="images/payment/jcb.png" alt="JCB">
                <img src="images/payment/momo.png" alt="Momo">
                <img src="images/payment/vnpay.png" alt="VNPay">
            </div>
        </div>
    </footer>

    <script src="app.js"></script>
    <script src="js/sync-pending.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load cart items
            function renderOrderSummary() {
                const cart = APP.getCart();
                if(cart.length === 0) {
                    window.location.href = 'cart.html';
                    return;
                }

                const orderItemsContainer = document.getElementById('orderItems');
                orderItemsContainer.innerHTML = '';

                let subtotal = 0;

                cart.forEach(item => {
                    const price = typeof item.price === 'number' ? item.price : parseInt(String(item.price).replace(/[^\d]/g, '')) || 0;
                    const itemTotal = price * (item.qty || 1);
                    subtotal += itemTotal;

                    const itemElement = document.createElement('div');
                    itemElement.className = 'order-item';
                    itemElement.innerHTML = `
                        <img src="${item.img || 'images/slider1.jpg'}" alt="${escapeHtml(item.title)}">
                        <div class="item-info">
                            <h4>${escapeHtml(item.title)}</h4>
                            <p>Size: ${item.size || '-'}</p>
                            <p>Số lượng: ${item.qty || 1}</p>
                            <div class="item-price">${formatVND(itemTotal)}</div>
                        </div>
                    `;
                    orderItemsContainer.appendChild(itemElement);
                });

                // Update totals
                document.getElementById('subtotal').textContent = formatVND(subtotal);
                document.getElementById('total').textContent = formatVND(subtotal);
            }

            // Initial render
            renderOrderSummary();

            // Try to sync any pending orders saved in localStorage
            if (window.syncPendingOrders) {
                syncPendingOrders();
            }

            // Xử lý chọn phương thức thanh toán
            const paymentMethods = document.querySelectorAll('.payment-method');
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    paymentMethods.forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Xử lý chọn tỉnh/thành phố
            const citySelect = document.getElementById('city');
            const districtSelect = document.getElementById('district');

            citySelect.addEventListener('change', function() {
                districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
                
                if(this.value === 'hanoi') {
                    const districts = ['Ba Đình', 'Hoàn Kiếm', 'Hai Bà Trưng', 'Đống Đa', 'Tây Hồ', 'Cầu Giấy', 'Thanh Xuân'];
                    districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.toLowerCase().replace(/\s+/g, '');
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                } else if(this.value === 'hcm') {
                    const districts = ['Quận 1', 'Quận 2', 'Quận 3', 'Quận 4', 'Quận 5', 'Quận 6', 'Quận 7'];
                    districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.toLowerCase().replace(/\s+/g, '');
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                }
            });
        });

        // Xử lý đặt hàng
        function placeOrder() {
            const form = document.getElementById('checkout-form');
            if(form.checkValidity()) {
                // Collect form data
                const orderData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    district: document.getElementById('district').value,
                    note: document.getElementById('note').value,
                    paymentMethod: document.querySelector('input[name="payment"]:checked').value,
                    items: APP.getCart()
                };

                // Try to POST order to backend API. If it fails (no server), fall back to localStorage and existing behavior.
                (async function(){
                    try {
                        const res = await fetch('/api/orders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                customer: {
                                    first_name: orderData.firstName,
                                    last_name: orderData.lastName,
                                    email: orderData.email,
                                    phone: orderData.phone
                                },
                                shipping_address: {
                                    name: orderData.firstName + ' ' + orderData.lastName,
                                    phone: orderData.phone,
                                    line1: orderData.address,
                                    city: orderData.city,
                                    district: orderData.district
                                },
                                items: orderData.items.map(i => ({ product_sku: i.id || i.sku || '', product_name: i.title, unit_price: i.price, quantity: i.qty || 1, image: i.img })),
                                subtotal: (orderData.items || []).reduce((s,it)=> s + ((it.price||0)*(it.qty||1)), 0),
                                shipping_fee: 0,
                                discount: 0,
                                tax: 0,
                                total_amount: (orderData.items || []).reduce((s,it)=> s + ((it.price||0)*(it.qty||1)), 0),
                                payment_method: orderData.paymentMethod,
                                note: orderData.note
                            })
                        });

                        if (!res.ok) throw new Error('Server returned ' + res.status);

                        const body = await res.json();
                        console.log('Order saved on server:', body);
                        alert('Đặt hàng thành công! Đơn hàng đã được lưu.');
                        APP.clearCart();
                        window.location.href = 'index.html';
                    } catch (err) {
                        console.warn('Failed to save order via API, falling back to local save', err);
                        // Fallback: save to localStorage (temporary) and also append to data/orders.json when running server manually
                        const pending = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
                        pending.push(Object.assign({created_at: new Date().toISOString(), status: 'pending'}, orderData));
                        localStorage.setItem('pendingOrders', JSON.stringify(pending));
                        alert('Đặt hàng thành công! (Lưu tạm trên trình duyệt). Khi có server, đơn sẽ được gửi tự động.');
                        APP.clearCart();
                        window.location.href = 'index.html';
                    }
                })();
            } else {
                alert('Vui lòng điền đầy đủ thông tin giao hàng.');
            }
        }
    </script>
</body>
</html>